<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>BlogBlogBlog - Template</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <!-- Themify Icons -->
    <link rel="stylesheet" href="../assets/fonts/themify-icons/themify-icons.css"> <!-- Set láº¡i href náº¿u cáº§n -->
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet" />
    <!-- Custom CSS -->
    <link rel="stylesheet" href="../assets/css/home_style.css"> <!-- Set láº¡i href náº¿u cáº§n -->
</head>
<body>
  <!-- Top Navbar -->
  <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom py-2">
        <div class="container-fluid px-4">
            <a class="navbar-brand logo" href="home.html">
              <img src="../img/logo.png" class="logo-img" alt="logo-image">
              BlogBlogBlog
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <div class="flex-grow-1 mx-4 d-none d-md-block">
                    <div class="search-bar-group input-group" style="margin-left: -16px;">
                        <span class="input-group-text bg-transparent border-0">
                            <i class="ti-search"></i>
                        </span>
                        <input type="text" class="form-control bg-transparent border-0" placeholder="Search" style="box-shadow: none;" />
                    </div>
                </div>
                <div class="d-flex align-items-center gap-3 ms-auto">
                    <a href="blogWriting.html" class="btn btn-write">
                        <i class="ti-pencil-alt"></i> Write
                    </a>
                    <!-- Language Dropdown -->
                    <div class="dropdown">
                        <button class="btn btn-light px-2 py-1 border-0 d-flex align-items-center gap-1"
                            type="button" id="langDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <span style="font-size: 1.2em;">ðŸ‡ºðŸ‡¸</span>
                            <i class="ti-angle-down ms-1" style="font-size: 0.8em;"></i>
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="langDropdown">
                            <li>
                                <a class="dropdown-item d-flex align-items-center gap-2" href="#">
                                    <span style="font-size:1.2em;">ðŸ‡»ðŸ‡³</span>
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item d-flex align-items-center gap-2" href="#">
                                    <span style="font-size:1.2em;">ðŸ‡«ðŸ‡·</span>
                                </a>
                            </li>
                            <!-- ThÃªm cÃ¡c ngÃ´n ngá»¯ khÃ¡c náº¿u cáº§n -->
                        </ul>
                    </div>
                    <a href="#" class="text-secondary text-decoration-none ms-2 me-1">
                        <i class="ti-bell fs-5"></i>
                    </a>
                    <div class="dropdown">
                        <a href="#" class="d-block" data-bs-toggle="dropdown" aria-expanded="false">
                            <img src="https://upload.wikimedia.org/wikipedia/en/1/1e/Him%C5%8Dto%21_Umaru-chan_volume_1_cover.jpg" class="rounded-circle" width="32" height="32" alt="Profile" />
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end mt-2">
                            <li><a class="dropdown-item" href="profile.html">Profile</a></li>
                            <li><hr class="dropdown-divider" /></li>
                            <li><a class="dropdown-item" href="login.html">Sign out</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </nav>
  <!-- Main Content -->
    <div class="container main-content">
        <div class="row">
            <!-- Main Section -->
            <main class="col-lg-9 col-md-9">
              <div class="profile-header">
                <h1 class="profile-name">Nguyen Cong Minh</h1>
              </div>
              <nav class="profile-nav">
                <ul class="nav">
                  <li class="nav-item">
                    <a class="nav-link active" href="#" data-tab="home">Home</a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="#" data-tab="about">About</a>
                  </li>
                </ul>
              </nav>
              <div id="home-content">
                <div class="text-center">
                  <p class="text-muted">Loading posts...</p>
                </div>
              </div>
              <!-- About Content (Hidden by default) -->
              <div id="about-content" style="display: none;">
                <div class="py-3">
                  <p>Passionate writer and technology enthusiast sharing insights on machine learning, web development, and data science.</p>
                </div>
              </div>
            </main>
            <!-- Sidebar -->
            <aside class="col-lg-3 col-md-3 d-none d-md-block border-start bg-white pt-4">
                <div class="sidebar-inner ps-4">
                  <div class="d-flex align-items-start mb-4">
                    <img src="https://upload.wikimedia.org/wikipedia/en/1/1e/Him%C5%8Dto%21_Umaru-chan_volume_1_cover.jpg" class="profile-avatar" alt="Nguyen Cong Minh">
                    <div class="profile-info">
                      <h3 class="profile-name-small">Nguyen Cong Minh</h3>
                      <a href="account.html" class="edit-profile-link">Edit profile</a>
                    </div>
                  </div>
                </div>
            </aside>
        </div>
    </div>

  <!-- Footer -->
  <footer class="main-footer mt-1">
        <hr class="footer-divider mb-4" />
        <div class="footer-links">
            <a href="#">Help</a>
            <a href="#">Status</a>
            <a href="#">About</a>
            <a href="#">Careers</a>
            <a href="#">Press</a>
            <a href="#">Blog</a>
            <a href="#">Privacy</a>
            <a href="#">Rules</a>
            <a href="#">Terms</a>
            <a href="#">Text to speech</a>
        </div>
  </footer> 
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Tab switching functionality
    document.querySelectorAll('[data-tab]').forEach(tab => {
      tab.addEventListener('click', function(e) {
        e.preventDefault();
        // Remove active class from all tabs
        document.querySelectorAll('[data-tab]').forEach(t => t.classList.remove('active'));
        // Add active class to clicked tab
        this.classList.add('active');        
        // Hide all content sections
        document.getElementById('home-content').style.display = 'none';
        document.getElementById('about-content').style.display = 'none';
        // Show the selected content
        const tabType = this.getAttribute('data-tab');
        document.getElementById(tabType + '-content').style.display = 'block';
      });
    });

    // Function to format date
    function formatDate(dateString) {
      const date = new Date(dateString);
      const now = new Date();
      const diffInSeconds = Math.floor((now - date) / 1000);
      
      if (diffInSeconds < 60) {
        return 'Just now';
      } else if (diffInSeconds < 3600) {
        const minutes = Math.floor(diffInSeconds / 60);
        return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
      } else if (diffInSeconds < 86400) {
        const hours = Math.floor(diffInSeconds / 3600);
        return `${hours} hour${hours > 1 ? 's' : ''} ago`;
      } else if (diffInSeconds < 2592000) {
        const days = Math.floor(diffInSeconds / 86400);
        return `${days} day${days > 1 ? 's' : ''} ago`;
      } else {
        const months = Math.floor(diffInSeconds / 2592000);
        return `${months} month${months > 1 ? 's' : ''} ago`;
      }
    }

    // Function to truncate content for subtitle
    function truncateContent(content, maxLength = 20) {
      if (content.length <= maxLength) {
        return content;
      }
      return content.substring(0, maxLength) + '...';
    }

    // Function to fetch and display posts
    async function loadPosts() {
      try {
        const token = localStorage.getItem('accessToken');
        if (!token) {
          console.error('No access token found');
          return;
        }

        const response = await fetch('http://localhost:3000/post-owner/get-all-posts', {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        const responseData = await response.json();
        // console.log('Response Data:', responseData);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${responseData.message}`);
        }
        console.log('Data:', responseData.data.posts);
        // Check if response contains posts
        if (responseData.data.posts && Array.isArray(responseData.data.posts)) {
          displayPosts(responseData.data.posts);
        } else {
          if(!responseData.data.posts) {
            const homeContent = document.getElementById('home-content');
            homeContent.innerHTML = '<p class="text-center text-muted">No posts found.</p>';
          } else {
            console.error('data format is incorrect:', responseData.message || 'No posts found');
          }
        }
      } catch (error) {
        console.error('Error fetching posts:', error);
      }
    }

    // Function to display posts
    function displayPosts(posts) {
      const homeContent = document.getElementById('home-content');
      console.log('Posts:', posts);
      if (!posts || posts.length === 0) {
        homeContent.innerHTML = '<p class="text-center text-muted">No posts found.</p>';
        return;
      }

      homeContent.innerHTML = posts.map(post => `
        <article class="blog-post">
          <div class="d-flex justify-content-between align-items-start">
            <div class="flex-grow-1">
              <h2><a href="post-detail.html?id=${post.postid}" class="blog-title">${post.title}</a></h2>
              <p class="blog-subtitle">${truncateContent(post.content)}</p>
              <div class="blog-meta">
                <span class="blog-date">${formatDate(post.createdAt)}</span>
                <div class="dropdown post-options">
                  <span class="more-options" role="button" data-bs-toggle="dropdown" aria-expanded="false">â‹¯</span>
                  <ul class="dropdown-menu">
                    <li><a class="dropdown-item edit-post-btn" href="#" data-post-id="${post.postid}">Edit</a></li>
                    <li><a class="dropdown-item delete-post-btn" href="#" data-post-id="${post.postid}">Delete</a></li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </article>
      `).join('');

      // Add event listeners for edit and delete buttons
      addPostActionListeners();
    }

    // Function to add event listeners for post actions
    function addPostActionListeners() {
      document.querySelectorAll('.edit-post-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
          e.preventDefault();
          const postId = this.getAttribute('data-post-id');
          // Redirect to edit page or open edit modal
          window.location.href = `blogWriting.html?edit=${postId}`;
        });
      });

      document.querySelectorAll('.delete-post-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
          e.preventDefault();
          const postId = this.getAttribute('data-post-id');
          deletePost(postId);
        });
      });
    }

    // Function to delete a post
    async function deletePost(postId) {
      if (!confirm('Are you sure you want to delete this post?')) {
        return;
      }

      try {
        const token = localStorage.getItem('accessToken');
        if (!token) {
          alert('You need to be logged in to delete posts.');
          return;
        }

        const response = await fetch('http://localhost:3000/post-owner/delete-post', {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ postid: parseInt(postId) })
        });

        const data = await response.json();
        
        if (response.ok && data.success) {
          alert('Post deleted successfully!');
          loadPosts(); // Reload posts
        } else {
          alert(data.message || 'Failed to delete post.');
        }
      } catch (error) {
        console.error('Error deleting post:', error);
        alert('An error occurred while deleting the post.');
      }
    }

    // Load posts when page loads
    document.addEventListener('DOMContentLoaded', function() {
      loadPosts();
    });
  </script>
</body>
</html>